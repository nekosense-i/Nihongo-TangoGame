<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥æœ¬èªã®æ—… (Japanese Journey)</title>
    <style>
        :root {
            /* å’Œé£è‰²æ¿ */
            --bg-paper: #fcfaf2; /* ç”Ÿæˆè‰² */
            --ink-black: #2b2b2b; /* å¢¨è‰² */
            --japan-blue: #2e4b75; /* è“æŸ“ */
            --vermilion: #c94a4a; /* é¸Ÿå±…çº¢ */
            --matcha: #6e8e59; /* æŠ¹èŒ¶ç»¿ */
            --sakura: #fbe0e0; /* æ¨±è‰²èƒŒæ™¯ */
            --sakura-deep: #e89da2; /* æ¨±è‰²æ·± */
            --wood: #8c7056; /* æœ¨è‰² */
            
            --shadow-soft: 2px 4px 10px rgba(44, 44, 44, 0.05);
            --border-ink: 1px solid rgba(0,0,0,0.1);
        }
        
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-paper);
            background-image: radial-gradient(#e6e2d3 1px, transparent 1px);
            background-size: 20px 20px; /* ç»†å¾®çš„å’Œçº¸é¢—ç²’æ„Ÿ */
            color: var(--ink-black);
            font-family: "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif; /* å¼ºåˆ¶è¡¬çº¿ä½“ */
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* åŠ¨ç”»å®šä¹‰ - æŸ”å’Œç‰ˆ */
        @keyframes float-gentle {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes ink-spread {
            0% { transform: scale(0.95); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake-ink {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-1deg); }
            75% { transform: translateX(5px) rotate(1deg); }
            100% { transform: translateX(0); }
        }
        
        @keyframes fade-up {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes sakura-float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }

        .shaking { animation: shake-ink 0.4s; color: var(--vermilion); }
        .popping { animation: ink-spread 0.3s ease-out; color: var(--japan-blue); }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            height: 70px;
            background: rgba(252, 250, 242, 0.9);
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-bottom: 2px solid #e0ddd0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            z-index: 10;
        }
        
        #level-scroller {
            flex: 1;
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding-right: 10px;
            scrollbar-width: none;
            align-items: center;
        }
        #level-scroller::-webkit-scrollbar { display: none; }
        
        .level-btn {
            min-width: 45px;
            height: 45px;
            background: #fff;
            border: 1px solid #dcdcdc;
            color: #888;
            border-radius: 50%; /* åœ†å½¢å°ç« é£æ ¼ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-family: sans-serif; /* æ•°å­—ç”¨æ— è¡¬çº¿ä½“æ›´æ¸…æ™° */
            font-size: 0.9rem;
            transition: all 0.3s;
            position: relative;
        }
        
        .level-btn.active {
            background: var(--japan-blue);
            color: #fff;
            border-color: var(--japan-blue);
            box-shadow: 0 2px 8px rgba(46, 75, 117, 0.3);
            transform: scale(1.1);
        }
        
        .level-btn.locked {
            background: #f0f0f0;
            color: #ccc;
            border: none;
            pointer-events: none;
        }

        .reset-btn {
            margin-left: 15px;
            color: var(--vermilion);
            border: 1px solid var(--vermilion);
            background: transparent;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            font-family: "Yu Mincho", serif;
            transition: all 0.2s;
        }
        .reset-btn:active { background: var(--vermilion); color: white; }

        /* æ ¸å¿ƒæ¸¸æˆåŒº */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 20px;
            z-index: 1;
        }

        #word-display {
            font-size: 4.5rem;
            margin-bottom: 40px;
            text-align: center;
            min-height: 90px;
            font-weight: bold;
            color: var(--ink-black);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05); /* ç±»ä¼¼å‡¸ç‰ˆå°åˆ·æ•ˆæœ */
            letter-spacing: 0.05em;
        }
        
        /* æ¿€åŠ±è¯æµ®åŠ¨å±‚ */
        #praise-layer {
            position: absolute;
            top: 15%;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 50;
        }
        
        .praise-text {
            font-size: 2rem;
            color: var(--vermilion); /* çº¢è‰²å°ç« æ„Ÿ */
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border: 2px solid var(--vermilion);
            border-radius: 8px;
            display: inline-block;
            box-shadow: 5px 5px 0 rgba(201, 74, 74, 0.2);
            animation: sakura-float 1.2s forwards;
            font-weight: bold;
            font-family: "Yu Mincho", serif;
        }

        #input-area {
            width: 100%;
            max-width: 650px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .option-container {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .option-label {
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: var(--wood);
            letter-spacing: 3px;
            margin-bottom: 15px;
            border-bottom: 1px dashed #dcdcdc;
            padding-bottom: 5px;
            font-family: sans-serif;
            opacity: 0.8;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
        }

        .choice-btn {
            padding: 12px 24px;
            border: 1px solid #d0d0d0;
            border-radius: 6px; /* æ–¹å½¢åœ†è§’ï¼Œæ›´åƒçº¸ç‰Œ */
            background: #fff;
            color: var(--ink-black);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
            flex-grow: 1;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 2px 0 #e0e0e0; /* çº¸ç‰Œåšåº¦æ„Ÿ */
            position: relative;
            top: 0;
        }

        .choice-btn:active {
            top: 2px;
            box-shadow: none;
        }

        .choice-btn.selected {
            border-color: var(--japan-blue);
            background: var(--japan-blue);
            color: #fff;
            box-shadow: 0 4px 10px rgba(46, 75, 117, 0.2);
            top: -1px;
        }

        /* åº•éƒ¨è£èª‰å¢™ */
        footer {
            height: 60px;
            border-top: 1px solid #e0ddd0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: #fdfdf9;
            overflow-x: auto;
            gap: 10px;
        }
        
        .trophy { font-size: 1.4rem; filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.1)); }

        /* é®ç½©ä¸æ¨¡æ€æ¡† */
        #overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(252, 250, 242, 0.95); /* ä¸é€æ˜åº¦é«˜çš„ç±³è‰²é®ç½© */
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            text-align: center;
            padding: 40px;
            border: 4px double var(--japan-blue);
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .result-title { font-size: 3.5rem; margin-bottom: 10px; color: var(--japan-blue); font-weight: bold; }
        .result-score { font-size: 1.5rem; color: #666; margin-bottom: 40px; font-family: sans-serif; }
        
        .action-btn {
            padding: 15px 50px;
            font-size: 1.2rem;
            background: var(--vermilion);
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(201, 74, 74, 0.3);
            font-family: "Yu Mincho", serif;
            transition: transform 0.2s;
        }
        .action-btn:hover { transform: scale(1.05); }
        
        /* éšè—ç±» */
        .hidden { display: none !important; }
        
        /* è¿›åº¦æ¡ */
        #progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 6px;
            background: var(--matcha);
            width: 0%;
            transition: width 0.5s ease;
            opacity: 0.8;
        }
        
        /* è£…é¥°èƒŒæ™¯åœ† */
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: var(--vermilion);
            opacity: 0.03;
            z-index: 0;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <div class="bg-circle" style="width: 300px; height: 300px; top: -50px; right: -50px;"></div>
    <div class="bg-circle" style="width: 200px; height: 200px; bottom: 50px; left: -50px; background: var(--japan-blue);"></div>

    <header>
        <div id="level-scroller"></div>
        <div class="reset-btn" onclick="resetData()">è¨˜éŒ²å‰Šé™¤</div>
    </header>
    
    <div id="progress-bar"></div>

    <main>
        <div id="word-display">é–‹å§‹</div>
        <div id="praise-layer"></div>
        
        <div id="input-area">
            <div id="reading-section" class="option-container">
                <div class="option-label">èª­ã¿æ–¹</div>
                <div id="reading-options" class="option-group"></div>
            </div>
            
            <div style="height: 10px;"></div>

            <div id="meaning-section" class="option-container">
                <div class="option-label">æ„å‘³</div>
                <div id="meaning-options" class="option-group"></div>
            </div>
        </div>
    </main>

    <footer id="trophy-wall">
        <span style="color:#888; font-size:0.8rem; margin-right:10px; font-family:sans-serif;">é”æˆç›®éŒ² :: </span>
    </footer>

    <canvas id="confetti-canvas" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:999;"></canvas>

    <div id="overlay">
        <div class="modal-content">
            <div class="result-title" id="res-title">çš†ä¼</div>
            <div class="result-score" id="res-score">æ­£è§£ç‡: 100%</div>
            <button class="action-btn" id="next-btn" onclick="nextLevel()">æ¬¡ã¸é€²ã‚€</button>
        </div>
    </div>

    <script>
        // æ•°æ®æºæ³¨å…¥
        const rawData = [{"w": "ç§", "r": "ã‚ãŸã—", "m": "æˆ‘", "p": "noun"}, {"w": "ã‚ãªãŸ", "r": "ã‚ãªãŸ", "m": "ä½ ", "p": "noun"}, {"w": "ã‚ã®äºº", "r": "ã‚ã®ã²ã¨", "m": "é‚£ä¸ªäºº", "p": "noun"}, {"w": "å…ˆç”Ÿ", "r": "ã›ã‚“ã›ã„", "m": "è€å¸ˆ", "p": "adj"}, {"w": "æ•™å¸«", "r": "ãã‚‡ã†ã—", "m": "æ•™å¸ˆ", "p": "noun"}, {"w": "å­¦ç”Ÿ", "r": "ãŒãã›ã„", "m": "å­¦ç”Ÿ", "p": "adj"}, {"w": "ä¼šç¤¾å“¡", "r": "ã‹ã„ã—ã‚ƒã„ã‚“", "m": "å…¬å¸èŒå‘˜", "p": "noun"}, {"w": "ç¤¾å“¡", "r": "ã—ã‚ƒã„ã‚“", "m": "èŒå‘˜", "p": "noun"}, {"w": "éŠ€è¡Œå“¡", "r": "ãã‚“ã“ã†ã„ã‚“", "m": "é“¶è¡Œå‘˜", "p": "noun"}, {"w": "åŒ»è€…", "r": "ã„ã—ã‚ƒ", "m": "åŒ»ç”Ÿ", "p": "noun"}, {"w": "ç ”ç©¶è€…", "r": "ã‘ã‚“ãã‚…ã†ã—ã‚ƒ", "m": "ç ”ç©¶äººå‘˜", "p": "noun"}, {"w": "å¤§å­¦", "r": "ã ã„ãŒã", "m": "å¤§å­¦", "p": "verb"}, {"w": "ã“ã‚Œ", "r": "ã“ã‚Œ", "m": "è¿™ä¸ª", "p": "noun"}, {"w": "ãã‚Œ", "r": "ãã‚Œ", "m": "é‚£ä¸ª", "p": "noun"}, {"w": "ã‚ã‚Œ", "r": "ã‚ã‚Œ", "m": "é‚£ä¸ªï¼ˆè¿œï¼‰", "p": "noun"}, {"w": "ã“ã®", "r": "ã“ã®", "m": "è¿™ä¸ª...", "p": "noun"}, {"w": "æœ¬", "r": "ã»ã‚“", "m": "ä¹¦", "p": "noun"}, {"w": "è¾æ›¸", "r": "ã˜ã—ã‚‡", "m": "è¾å…¸", "p": "noun"}, {"w": "é›‘èªŒ", "r": "ã–ã£ã—", "m": "æ‚å¿—", "p": "noun"}, {"w": "æ–°è", "r": "ã—ã‚“ã¶ã‚“", "m": "æŠ¥çº¸", "p": "noun"}, {"w": "ãƒãƒ¼ãƒˆ", "r": "ã®ãƒ¼ã¨", "m": "ç¬”è®°æœ¬", "p": "noun"}, {"w": "æ‰‹å¸³", "r": "ã¦ã¡ã‚‡ã†", "m": "è®°äº‹æœ¬", "p": "verb"}, {"w": "ååˆº", "r": "ã‚ã„ã—", "m": "åç‰‡", "p": "noun"}, {"w": "é‰›ç­†", "r": "ãˆã‚“ã´ã¤", "m": "é“…ç¬”", "p": "verb"}, {"w": "ã“ã“", "r": "ã“ã“", "m": "è¿™é‡Œ", "p": "noun"}, {"w": "ãã“", "r": "ãã“", "m": "é‚£é‡Œ", "p": "noun"}, {"w": "ã‚ãã“", "r": "ã‚ãã“", "m": "é‚£é‡Œï¼ˆè¿œï¼‰", "p": "noun"}, {"w": "ã©ã“", "r": "ã©ã“", "m": "å“ªé‡Œ", "p": "noun"}, {"w": "æ•™å®¤", "r": "ãã‚‡ã†ã—ã¤", "m": "æ•™å®¤", "p": "verb"}, {"w": "é£Ÿå ‚", "r": "ã—ã‚‡ãã©ã†", "m": "é£Ÿå ‚", "p": "verb"}, {"w": "äº‹å‹™æ‰€", "r": "ã˜ã‚€ã—ã‚‡", "m": "åŠå…¬å®¤", "p": "noun"}, {"w": "å—ä»˜", "r": "ã†ã‘ã¤ã‘", "m": "æ¥å¾…å¤„", "p": "noun"}, {"w": "ãƒ­ãƒ“ãƒ¼", "r": "ã‚ã³ãƒ¼", "m": "å¤§å…", "p": "noun"}, {"w": "éƒ¨å±‹", "r": "ã¸ã‚„", "m": "æˆ¿é—´", "p": "noun"}, {"w": "ãŠæ‰‹æ´—ã„", "r": "ãŠã¦ã‚ã‚‰ã„", "m": "æ´—æ‰‹é—´", "p": "adj"}, {"w": "éšæ®µ", "r": "ã‹ã„ã ã‚“", "m": "æ¥¼æ¢¯", "p": "noun"}, {"w": "èµ·ãã‚‹", "r": "ãŠãã‚‹", "m": "èµ·åºŠ", "p": "verb"}, {"w": "å¯ã‚‹", "r": "ã­ã‚‹", "m": "ç¡è§‰", "p": "verb"}, {"w": "åƒã", "r": "ã¯ãŸã‚‰ã", "m": "å·¥ä½œ", "p": "verb"}, {"w": "ä¼‘ã‚€", "r": "ã‚„ã™ã‚€", "m": "ä¼‘æ¯", "p": "verb"}, {"w": "å‹‰å¼·ã™ã‚‹", "r": "ã¹ã‚“ãã‚‡ã†ã™ã‚‹", "m": "å­¦ä¹ ", "p": "verb"}, {"w": "çµ‚ã‚ã‚‹", "r": "ãŠã‚ã‚‹", "m": "ç»“æŸ", "p": "verb"}, {"w": "ãƒ‡ãƒ‘ãƒ¼ãƒˆ", "r": "ã§ã±ãƒ¼ã¨", "m": "ç™¾è´§å…¬å¸", "p": "noun"}, {"w": "éŠ€è¡Œ", "r": "ãã‚“ã“ã†", "m": "é“¶è¡Œ", "p": "verb"}, {"w": "éƒµä¾¿å±€", "r": "ã‚†ã†ã³ã‚“ãã‚‡ã", "m": "é‚®å±€", "p": "verb"}, {"w": "å›³æ›¸é¤¨", "r": "ã¨ã—ã‚‡ã‹ã‚“", "m": "å›¾ä¹¦é¦†", "p": "noun"}, {"w": "ç¾è¡“é¤¨", "r": "ã³ã˜ã‚…ã¤ã‹ã‚“", "m": "ç¾æœ¯é¦†", "p": "noun"}, {"w": "ä»Š", "r": "ã„ã¾", "m": "ç°åœ¨", "p": "noun"}, {"w": "è¡Œã", "r": "ã„ã", "m": "å»", "p": "verb"}, {"w": "æ¥ã‚‹", "r": "ãã‚‹", "m": "æ¥", "p": "verb"}, {"w": "å¸°ã‚‹", "r": "ã‹ãˆã‚‹", "m": "å›å®¶", "p": "verb"}, {"w": "å­¦æ ¡", "r": "ãŒã£ã“ã†", "m": "å­¦æ ¡", "p": "verb"}, {"w": "ã‚¹ãƒ¼ãƒ‘ãƒ¼", "r": "ã™ãƒ¼ã±ãƒ¼", "m": "è¶…å¸‚", "p": "noun"}, {"w": "é§…", "r": "ãˆã", "m": "è½¦ç«™", "p": "noun"}, {"w": "é£›è¡Œæ©Ÿ", "r": "ã²ã“ã†ã", "m": "é£æœº", "p": "noun"}, {"w": "èˆ¹", "r": "ãµã­", "m": "èˆ¹", "p": "noun"}, {"w": "é›»è»Š", "r": "ã§ã‚“ã—ã‚ƒ", "m": "ç”µè½¦", "p": "noun"}, {"w": "åœ°ä¸‹é‰„", "r": "ã¡ã‹ã¦ã¤", "m": "åœ°é“", "p": "verb"}, {"w": "æ–°å¹¹ç·š", "r": "ã—ã‚“ã‹ã‚“ã›ã‚“", "m": "æ–°å¹²çº¿", "p": "noun"}, {"w": "è‡ªè»¢è»Š", "r": "ã˜ã¦ã‚“ã—ã‚ƒ", "m": "è‡ªè¡Œè½¦", "p": "noun"}, {"w": "é£Ÿã¹ã‚‹", "r": "ãŸã¹ã‚‹", "m": "åƒ", "p": "verb"}, {"w": "é£²ã‚€", "r": "ã®ã‚€", "m": "å–", "p": "verb"}, {"w": "å¸ã†", "r": "ã™ã†", "m": "å¸ï¼ˆçƒŸï¼‰", "p": "verb"}, {"w": "è¦‹ã‚‹", "r": "ã¿ã‚‹", "m": "çœ‹", "p": "verb"}, {"w": "èã", "r": "ãã", "m": "å¬", "p": "verb"}, {"w": "èª­ã‚€", "r": "ã‚ˆã‚€", "m": "è¯»", "p": "verb"}, {"w": "æ›¸ã", "r": "ã‹ã", "m": "å†™", "p": "verb"}, {"w": "è²·ã†", "r": "ã‹ã†", "m": "ä¹°", "p": "verb"}, {"w": "æ’®ã‚‹", "r": "ã¨ã‚‹", "m": "ç…§ç›¸", "p": "verb"}, {"w": "ã™ã‚‹", "r": "ã™ã‚‹", "m": "åš", "p": "verb"}, {"w": "ä¼šã†", "r": "ã‚ã†", "m": "é‡è§", "p": "verb"}, {"w": "å¾¡é£¯", "r": "ã”ã¯ã‚“", "m": "é¥­", "p": "noun"}, {"w": "åˆ‡ã‚‹", "r": "ãã‚‹", "m": "å‰ªã€åˆ‡", "p": "verb"}, {"w": "é€ã‚‹", "r": "ãŠãã‚‹", "m": "å¯„ã€é€", "p": "verb"}, {"w": "ã‚ã’ã‚‹", "r": "ã‚ã’ã‚‹", "m": "ç»™", "p": "verb"}, {"w": "ã‚‚ã‚‰ã†", "r": "ã‚‚ã‚‰ã†", "m": "å¾—åˆ°", "p": "verb"}, {"w": "è²¸ã™", "r": "ã‹ã™", "m": "å€Ÿå‡º", "p": "noun"}, {"w": "å€Ÿã‚Šã‚‹", "r": "ã‹ã‚Šã‚‹", "m": "å€Ÿå…¥", "p": "verb"}, {"w": "æ•™ãˆã‚‹", "r": "ãŠã—ãˆã‚‹", "m": "æ•™", "p": "verb"}, {"w": "ç¿’ã†", "r": "ãªã‚‰ã†", "m": "å­¦ä¹ ", "p": "verb"}, {"w": "ã‹ã‘ã‚‹", "r": "ã‹ã‘ã‚‹", "m": "æ‰“ï¼ˆç”µè¯ï¼‰", "p": "verb"}, {"w": "æ‰‹", "r": "ã¦", "m": "æ‰‹", "p": "noun"}, {"w": "ç®¸", "r": "ã¯ã—", "m": "ç­·å­", "p": "noun"}, {"w": "ã‚¹ãƒ—ãƒ¼ãƒ³", "r": "ã™ã·ãƒ¼ã‚“", "m": "å‹ºå­", "p": "noun"}, {"w": "ãƒãƒ³ã‚µãƒ ", "r": "ãƒãƒ³ã‚µãƒ ", "m": "è‹±ä¿Š", "p": "noun"}, {"w": "ç¶ºéº—", "r": "ãã‚Œã„", "m": "æ¼‚äº®ã€å¹²å‡€", "p": "adj"}, {"w": "é™ã‹", "r": "ã—ãšã‹", "m": "å®‰é™", "p": "noun"}, {"w": "è³‘ã‚„ã‹", "r": "ã«ãã‚„ã‹", "m": "çƒ­é—¹", "p": "noun"}, {"w": "æœ‰å", "r": "ã‚†ã†ã‚ã„", "m": "æœ‰å", "p": "adj"}, {"w": "è¦ªåˆ‡", "r": "ã—ã‚“ã›ã¤", "m": "äº²åˆ‡", "p": "verb"}, {"w": "å…ƒæ°—", "r": "ã’ã‚“ã", "m": "å¥åº·ã€ç²¾åŠ›å……æ²›", "p": "noun"}, {"w": "æš‡", "r": "ã²ã¾", "m": "ç©ºé—²", "p": "noun"}, {"w": "ä¾¿åˆ©", "r": "ã¹ã‚“ã‚Š", "m": "ä¾¿åˆ©", "p": "noun"}, {"w": "ç´ æ•µ", "r": "ã™ã¦ã", "m": "æå¥½", "p": "noun"}, {"w": "å¤§ãã„", "r": "ãŠãŠãã„", "m": "å¤§", "p": "adj"}, {"w": "å°ã•ã„", "r": "ã¡ã„ã•ã„", "m": "å°", "p": "adj"}, {"w": "æ–°ã—ã„", "r": "ã‚ãŸã‚‰ã—ã„", "m": "æ–°", "p": "adj"}, {"w": "å¤ã„", "r": "ãµã‚‹ã„", "m": "æ—§", "p": "adj"}, {"w": "è‰¯ã„", "r": "ã„ã„", "m": "å¥½", "p": "adj"}, {"w": "æ‚ªã„", "r": "ã‚ã‚‹ã„", "m": "å", "p": "adj"}];
        
        const WORDS_PER_LEVEL = 20;
        const PASS_THRESHOLD = 0.8;
        const PERFECT_THRESHOLD = 0.9;
        
        // å’Œé£æ¿€åŠ±è¯åº“
        const PRAISE_WORDS = [
            "ãŠè¦‹äº‹ï¼", "ç´ æ™´ã‚‰ã—ã„", "æ­£è§£", 
            "å¤©æ™´ã‚Œï¼", "æµçŸ³ã§ã™", "ãã®èª¿å­",
            "å®Œç’§", "é›…ã‚„ã‹"
        ];
        
        // å­˜å‚¨æ¨¡å—
        const DB = {
            mem: {},
            save: function(key, val) {
                this.mem[key] = val;
                try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
            },
            load: function(key, def) {
                try {
                    const v = localStorage.getItem(key);
                    return v ? JSON.parse(v) : def;
                } catch(e) {
                    return this.mem[key] || def;
                }
            },
            clear: function() {
                try { localStorage.clear(); } catch(e) {}
                this.mem = {};
            }
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            currentLevel: 1, maxLevel: 1, honors: {},
            queue: [], currentIndex: 0, correctCount: 0,
            wrongList: [], isRetryMode: false, retrySuccessCount: 0,
            selection: { r: null, m: null }
        };

        function initGame() {
            const savedMax = DB.load('maxLevel', 1);
            gameState.maxLevel = savedMax;
            gameState.honors = DB.load('honors', {});
            renderLevelSelector();
            renderTrophyWall();
            startLevel(savedMax);
        }

        function startLevel(lvl) {
            gameState.currentLevel = lvl;
            gameState.correctCount = 0;
            gameState.wrongList = [];
            gameState.currentIndex = 0;
            gameState.isRetryMode = false;
            gameState.selection = { r: null, m: null };
            
            const startIdx = (lvl - 1) * WORDS_PER_LEVEL;
            if (startIdx >= rawData.length) {
                alert("å…¨å·»ä¿®äº†ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ (Complete!)");
                return;
            }
            
            let slice = rawData.slice(startIdx, startIdx + WORDS_PER_LEVEL);
            if (slice.length === 0) slice = rawData.slice(-WORDS_PER_LEVEL);

            gameState.queue = shuffle(slice);
            updateUIState();
            renderQuestion();
        }
        
        function startRetryMode() {
            gameState.isRetryMode = true;
            gameState.queue = shuffle([...gameState.wrongList]); 
            gameState.correctCount = 0;
            gameState.wrongList = []; 
            gameState.currentIndex = 0;
            updateUIState();
            renderQuestion();
        }

        function renderQuestion() {
            const q = gameState.queue[gameState.currentIndex];
            const wordDisplay = document.getElementById('word-display');
            
            wordDisplay.innerText = q.w;
            wordDisplay.classList.remove('popping');
            document.body.classList.remove('shaking');
            gameState.selection = { r: null, m: null };

            // 1. è¯»éŸ³é€‰é¡¹
            const rContainer = document.getElementById('reading-options');
            rContainer.innerHTML = '';
            
            const isPureKana = /^[ã€-ã‚Ÿã‚ -ãƒ¿]+$/.test(q.w);
            document.getElementById('reading-section').classList.toggle('hidden', isPureKana);
            
            if (isPureKana) {
                gameState.selection.r = 'AUTO_CORRECT';
            } else {
                let distractors = getReadingDistractors(q);
                let options = shuffle([q.r, ...distractors]);
                options.forEach(opt => {
                    let btn = createOptionBtn(opt, 'r', opt === q.r);
                    rContainer.appendChild(btn);
                });
            }

            // 2. å«ä¹‰é€‰é¡¹
            const mContainer = document.getElementById('meaning-options');
            mContainer.innerHTML = '';
            
            const isDirectMatch = (q.w === q.m); 
            document.getElementById('meaning-section').classList.toggle('hidden', isDirectMatch);

            if (isDirectMatch) {
                gameState.selection.m = 'AUTO_CORRECT';
            } else {
                let distractors = getMeaningDistractors(q);
                let options = shuffle([q.m, ...distractors]);
                options.forEach(opt => {
                    let btn = createOptionBtn(opt, 'm', opt === q.m);
                    mContainer.appendChild(btn);
                });
            }
            
            const pct = ((gameState.currentIndex) / gameState.queue.length) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';
        }

        function getReadingDistractors(targetWord) {
            const correct = targetWord.r;
            const lastChar = correct.slice(-1);
            let candidates = rawData.filter(x => x.r.endsWith(lastChar) && x.r !== correct && Math.abs(x.r.length - correct.length) < 3);
            if (candidates.length < 3) {
                let randoms = rawData.filter(x => x.r !== correct);
                candidates = [...candidates, ...randoms];
            }
            return shuffle(candidates).slice(0, 3).map(x => x.r);
        }

        function getMeaningDistractors(targetWord) {
            let pool = rawData.filter(x => x.m !== targetWord.m);
            let samePos = pool.filter(x => x.p === targetWord.p);
            if (samePos.length >= 3) {
                return shuffle(samePos).slice(0, 3).map(x => x.m);
            } else {
                return shuffle(pool).slice(0, 3).map(x => x.m);
            }
        }

        function createOptionBtn(text, type, isCorrect) {
            const btn = document.createElement('div');
            btn.className = 'choice-btn';
            btn.innerText = text;
            btn.onclick = () => handleSelect(btn, type, isCorrect);
            return btn;
        }

        function handleSelect(btn, type, isCorrect) {
            const container = type === 'r' ? document.getElementById('reading-options') : document.getElementById('meaning-options');
            Array.from(container.children).forEach(c => c.classList.remove('selected'));
            btn.classList.add('selected');
            
            gameState.selection[type] = isCorrect;
            
            if (gameState.selection.r !== null && gameState.selection.m !== null) {
                setTimeout(evaluateAnswer, 200); 
            }
        }

        function evaluateAnswer() {
            const rCorrect = gameState.selection.r === true || gameState.selection.r === 'AUTO_CORRECT';
            const mCorrect = gameState.selection.m === true || gameState.selection.m === 'AUTO_CORRECT';
            
            if (rCorrect && mCorrect) {
                triggerSakura(); // æ¨±èŠ±ç‰¹æ•ˆ
                showPraise();
                document.getElementById('word-display').classList.add('popping');
                gameState.correctCount++;
            } else {
                document.body.classList.add('shaking');
                setTimeout(() => document.body.classList.remove('shaking'), 500);
                gameState.wrongList.push(gameState.queue[gameState.currentIndex]);
            }
            
            setTimeout(() => {
                gameState.currentIndex++;
                if (gameState.currentIndex >= gameState.queue.length) {
                    endLevel();
                } else {
                    renderQuestion();
                }
            }, 1000);
        }

        function showPraise() {
            const praiseLayer = document.getElementById('praise-layer');
            const el = document.createElement('div');
            el.className = 'praise-text';
            el.innerText = PRAISE_WORDS[Math.floor(Math.random() * PRAISE_WORDS.length)];
            praiseLayer.innerHTML = '';
            praiseLayer.appendChild(el);
            setTimeout(() => { if(el.parentNode) el.parentNode.removeChild(el); }, 1000);
        }

        function endLevel() {
            const total = gameState.queue.length;
            const score = gameState.correctCount / total;
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('res-title');
            const scoreTxt = document.getElementById('res-score');
            const nextBtn = document.getElementById('next-btn');
            
            overlay.style.display = 'flex';
            scoreTxt.innerText = `æ­£è§£ç‡: ${Math.round(score * 100)}%`;
            
            if (gameState.isRetryMode) {
                if (score >= 1.0) {
                    gameState.retrySuccessCount++;
                    if (gameState.retrySuccessCount >= 2) {
                         title.innerText = "å¾©æ´»";
                         title.style.color = "var(--matcha)";
                         nextBtn.innerText = "æˆ»ã‚‹";
                         nextBtn.onclick = () => { overlay.style.display = 'none'; startLevel(gameState.currentLevel + 1); };
                    } else {
                        title.innerText = "ã‚ã¨ä¸€æ¯";
                         title.style.color = "#d4af37";
                         nextBtn.innerText = "ã‚‚ã†ä¸€åº¦";
                         nextBtn.onclick = () => { overlay.style.display = 'none'; startRetryMode(); };
                    }
                } else {
                    gameState.retrySuccessCount = 0; 
                    title.innerText = "ä¿®è¡Œä¸è¶³";
                    title.style.color = "var(--vermilion)";
                    nextBtn.innerText = "å†ä¿®è¡Œ";
                    nextBtn.onclick = () => { overlay.style.display = 'none'; startRetryMode(); };
                }
                return;
            }

            if (score >= PERFECT_THRESHOLD) {
                title.innerText = "çš†ä¼ (PERFECT)";
                title.style.color = "var(--japan-blue)";
                saveProgress('ğŸŒ¸'); // å®Œç¾ç»™æ¨±èŠ±
                nextBtn.innerText = "æ¬¡ã¸é€²ã‚€";
                nextBtn.onclick = () => { overlay.style.display = 'none'; startLevel(gameState.currentLevel + 1); };
            } else if (score >= PASS_THRESHOLD) {
                title.innerText = "åˆæ ¼";
                title.style.color = "var(--matcha)";
                saveProgress('ğŸµ'); // åˆæ ¼ç»™æŠ¹èŒ¶
                nextBtn.innerText = "æ¬¡ã¸é€²ã‚€";
                nextBtn.onclick = () => { overlay.style.display = 'none'; startLevel(gameState.currentLevel + 1); };
            } else {
                title.innerText = "ä¸åˆæ ¼";
                title.style.color = "var(--vermilion)";
                saveProgress('ğŸ‚'); // å¤±è´¥ç»™è½å¶
                nextBtn.innerText = "ä¿®è¡Œã¸";
                nextBtn.onclick = () => { overlay.style.display = 'none'; startRetryMode(); };
            }
        }
        
        function saveProgress(medal) {
            if (!gameState.isRetryMode) {
                const oldMedal = gameState.honors[gameState.currentLevel];
                // æ¨±èŠ± > æŠ¹èŒ¶ > è½å¶
                const rank = {'ğŸŒ¸':3, 'ğŸµ':2, 'ğŸ‚':1};
                if (!oldMedal || (rank[medal] > rank[oldMedal])) {
                    gameState.honors[gameState.currentLevel] = medal;
                    DB.save('honors', gameState.honors);
                }
                if (medal !== 'ğŸ‚' && gameState.currentLevel === gameState.maxLevel) {
                    gameState.maxLevel++;
                    DB.save('maxLevel', gameState.maxLevel);
                }
            }
            renderTrophyWall();
            renderLevelSelector();
        }

        function renderLevelSelector() {
            const scroller = document.getElementById('level-scroller');
            scroller.innerHTML = '';
            const totalLevels = Math.ceil(rawData.length / WORDS_PER_LEVEL);
            
            for (let i = 1; i <= totalLevels; i++) {
                const btn = document.createElement('div');
                btn.className = `level-btn ${i > gameState.maxLevel ? 'locked' : ''} ${i === gameState.currentLevel ? 'active' : ''}`;
                let content = `${i}`;
                // æ˜¾ç¤ºå¾½ç« 
                if (gameState.honors[i]) {
                     // å¦‚æœæœ‰å¾½ç« ï¼Œæ˜¾ç¤ºå¾½ç« åœ¨è§’è½
                     const badge = document.createElement('span');
                     badge.innerText = gameState.honors[i];
                     badge.style.position = 'absolute';
                     badge.style.bottom = '-5px';
                     badge.style.right = '-5px';
                     badge.style.fontSize = '0.8rem';
                     btn.appendChild(badge);
                }
                
                // btn.innerHTML = content; // Keep number
                const numSpan = document.createElement('span');
                numSpan.innerText = i;
                btn.appendChild(numSpan);

                if (i <= gameState.maxLevel) btn.onclick = () => startLevel(i);
                scroller.appendChild(btn);
            }
        }
        
        function renderTrophyWall() {
            const wall = document.getElementById('trophy-wall');
            wall.innerHTML = '<span style="color:#888; font-size:0.8rem; margin-right:10px; font-family:sans-serif;">é”æˆç›®éŒ² :: </span>';
            Object.keys(gameState.honors).sort((a,b)=>a-b).forEach(lvl => {
                const span = document.createElement('span');
                span.className = 'trophy';
                span.innerText = gameState.honors[lvl];
                wall.appendChild(span);
            });
        }

        function updateUIState() { renderLevelSelector(); }
        function shuffle(array) {
            let c = array.length, r;
            while (c != 0) { r = Math.floor(Math.random() * c); c--; [array[c], array[r]] = [array[r], array[c]]; }
            return array;
        }

        function resetData() {
            if(confirm("è­¦å‘Šï¼šã™ã¹ã¦ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { DB.clear(); location.reload(); }
        }

        // Sakura Engine (Modified Confetti)
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        
        // æ¨±èŠ±è‰²æ¿
        const sakuraColors = ['#ffb7c5', '#ff9aa2', '#ffd1d1', '#fff0f0'];

        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resizeCanvas; resizeCanvas();
        
        function triggerSakura() {
            for (let i = 0; i < 40; i++) particles.push({
                x: window.innerWidth/2, y: window.innerHeight/2,
                vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15 - 5, // å‘ä¸Šå–·å‘
                life: 1,
                size: Math.random() * 8 + 5,
                color: sakuraColors[Math.floor(Math.random()*sakuraColors.length)],
                rotation: Math.random() * 360,
                spin: (Math.random() - 0.5) * 10
            });
        }
        
        function updateSakura() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                p.x += p.vx; 
                p.y += p.vy; 
                p.vy += 0.2; // é‡åŠ›
                p.vx *= 0.96; // ç©ºæ°”é˜»åŠ›
                p.life -= 0.015;
                p.rotation += p.spin;

                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life;
                // ç»˜åˆ¶èŠ±ç“£å½¢çŠ¶
                ctx.beginPath();
                ctx.ellipse(0, 0, p.size, p.size/2, 0, 0, 2 * Math.PI);
                ctx.fill();
                ctx.restore();
                
                if (p.life <= 0) particles.splice(i, 1);
            });
            requestAnimationFrame(updateSakura);
        }
        updateSakura();
        
        initGame();
    </script>
</body>
</html>
